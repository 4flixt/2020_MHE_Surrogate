

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Getting started: Moving Horizon Estimation &mdash; do-mpc 4.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"extensions": ["tex2jax.js"], "jax": ["input/TeX", "output/HTML-CSS"], "tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="License" href="license.html" />
    <link rel="prev" title="Getting started" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/dompc_var_02_white.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting started: Moving Horizon Estimation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Creating-the-model">Creating the model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Model-variables">Model variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Model-measurements">Model measurements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Model-parameters">Model parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Right-hand-side-equation">Right-hand-side equation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Configuring-the-Moving-Horizon-Estimator">Configuring the Moving Horizon Estimator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#MHE-parameters:">MHE parameters:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Cost-Function">Cost Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Fixed-parameters">Fixed parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Bounds">Bounds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Setup">Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Configuring-the-Simulator">Configuring the Simulator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Simulator-parameters">Simulator parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Parameters">Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Setup">Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Creating-the-loop">Creating the loop</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Setting-up-the-Graphic">Setting up the Graphic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Running-the-loop">Running the loop</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">do-mpc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Getting started: Moving Horizon Estimation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/mhe_example.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Getting-started:-Moving-Horizon-Estimation">
<h1>Getting started: Moving Horizon Estimation<a class="headerlink" href="#Getting-started:-Moving-Horizon-Estimation" title="Permalink to this headline">¶</a></h1>
<p>In this Jupyter Notebook we illustrate application of the <strong>do mpc</strong> moving horizon estimation module. Please follow first the general <strong>Getting Started</strong> guide, as we cover the sample example and skip over some previously explained details.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">casadi</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1"># Add to path:</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">)</span>

<span class="c1"># Import do_mpc package:</span>
<span class="kn">import</span> <span class="nn">do_mpc</span>
</pre></div>
</div>
</div>
<div class="section" id="Creating-the-model">
<h2>Creating the model<a class="headerlink" href="#Creating-the-model" title="Permalink to this headline">¶</a></h2>
<p>First, we need to decide on the model type. For the given example, we are working with a continuous model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;continuous&#39;</span> <span class="c1"># either &#39;discrete&#39; or &#39;continuous&#39;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Model-variables">
<h3>Model variables<a class="headerlink" href="#Model-variables" title="Permalink to this headline">¶</a></h3>
<p>The next step is to define the model variables. It is important to define the variable type, name and optionally shape (default is scalar variable).</p>
<p>In contrast to the previous example, we now use vectors for all variables.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">phi</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">dphi</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;dphi&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Two states for the desired (set) motor position:</span>
<span class="n">phi_m_set</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_m_set&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Two additional states for the true motor position:</span>
<span class="n">phi_m</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_m&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Model-measurements">
<h3>Model measurements<a class="headerlink" href="#Model-measurements" title="Permalink to this headline">¶</a></h3>
<p>This step is essential for the state estimation task: We must define a measurable output. Typcially, this is a subset of states (or a transformation thereof) as well as the inputs.</p>
<p>Note that some MHE implementations consider inputs seperatly.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># State measurements</span>
<span class="n">phi_meas</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_meas</span><span class="p">(</span><span class="s1">&#39;phi_1_meas&#39;</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>

<span class="c1"># Input measurements</span>
<span class="n">phi_m_set_meas</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_meas</span><span class="p">(</span><span class="s1">&#39;phi_m_set_meas&#39;</span><span class="p">,</span> <span class="n">phi_m_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Model-parameters">
<h3>Model parameters<a class="headerlink" href="#Model-parameters" title="Permalink to this headline">¶</a></h3>
<p>Next we <strong>define parameters</strong>. The MHE allows to estimate parameters as well as states. Note that not all parameters must be estimated (as shown in the MHE setup below). We can also hardcode parameters (suche as the spring constants <code class="docutils literal notranslate"><span class="pre">c</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Theta_1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">)</span>
<span class="n">Theta_2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_2&#39;</span><span class="p">)</span>
<span class="n">Theta_3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_3&#39;</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.697</span><span class="p">,</span>  <span class="mf">2.66</span><span class="p">,</span>  <span class="mf">3.05</span><span class="p">,</span> <span class="mf">2.86</span><span class="p">])</span><span class="o">*</span><span class="mf">1e-3</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.78</span><span class="p">,</span>  <span class="mf">8.01</span><span class="p">,</span>  <span class="mf">8.82</span><span class="p">])</span><span class="o">*</span><span class="mf">1e-5</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Right-hand-side-equation">
<h3>Right-hand-side equation<a class="headerlink" href="#Right-hand-side-equation" title="Permalink to this headline">¶</a></h3>
<p>Finally, we set the right-hand-side of the model by calling <code class="docutils literal notranslate"><span class="pre">model.set_rhs(var_name,</span> <span class="pre">expr)</span></code> with the <code class="docutils literal notranslate"><span class="pre">var_name</span></code> from the state variables defined above and an expression in terms of <span class="math notranslate nohighlight">\(x, u, z, p\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="n">dphi</span><span class="p">)</span>

<span class="n">dphi_next</span> <span class="o">=</span> <span class="n">vertcat</span><span class="p">(</span>
    <span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_1</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">phi_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_1</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_1</span><span class="o">*</span><span class="n">dphi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_2</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_2</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">phi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_2</span><span class="o">*</span><span class="n">dphi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_3</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_3</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">phi_m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_3</span><span class="o">*</span><span class="n">dphi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;dphi&#39;</span><span class="p">,</span> <span class="n">dphi_next</span><span class="p">)</span>

<span class="n">tau</span> <span class="o">=</span> <span class="mf">1e-2</span>
<span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;phi_m&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">tau</span><span class="o">*</span><span class="p">(</span><span class="n">phi_m_set</span> <span class="o">-</span> <span class="n">phi_m</span><span class="p">))</span>

</pre></div>
</div>
</div>
<p>The model setup is completed by calling <code class="docutils literal notranslate"><span class="pre">model.setup_model()</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model</span><span class="o">.</span><span class="n">setup_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>After calling <code class="docutils literal notranslate"><span class="pre">model.setup_model()</span></code> we cannot define further variables etc.</p>
</div>
</div>
<div class="section" id="Configuring-the-Moving-Horizon-Estimator">
<h2>Configuring the Moving Horizon Estimator<a class="headerlink" href="#Configuring-the-Moving-Horizon-Estimator" title="Permalink to this headline">¶</a></h2>
<p>The first step of configuring the moving horizon estimator is to call the class with a list of all parameters to be estimated. An empty list (default value) means that no parameters are estimated. The list of estimated parameters must be a subset (or all) of the previously defined parameters.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mhe</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">MHE</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Theta_1&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="MHE-parameters:">
<h3>MHE parameters:<a class="headerlink" href="#MHE-parameters:" title="Permalink to this headline">¶</a></h3>
<p>Next we pass MHE parameters. Most importantly, we need to set the time step and the horizon. We also choose here, to obtain the measurement from the MHE data object. Alternatively, we are able to set a user defined measurement function that is called at each timestep and returns the <code class="docutils literal notranslate"><span class="pre">N</span></code> previous measurements for the estimation step.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">setup_mhe</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;t_step&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;n_horizon&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;store_full_solution&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;meas_from_data&#39;</span><span class="p">:</span> <span class="kc">True</span>
<span class="p">}</span>
<span class="n">mhe</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">setup_mhe</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Cost-Function">
<h3>Cost Function<a class="headerlink" href="#Cost-Function" title="Permalink to this headline">¶</a></h3>
<p>The most important step of the configuration is to define the MHE cost function. The <strong>do mpc</strong> MHE implementation allows maximum flexiblity in that sense. We retrieve the variables <code class="docutils literal notranslate"><span class="pre">_y_meas</span></code>, <code class="docutils literal notranslate"><span class="pre">_y_calc</span></code>, <code class="docutils literal notranslate"><span class="pre">_x_prev</span></code>, <code class="docutils literal notranslate"><span class="pre">_x</span></code>, <code class="docutils literal notranslate"><span class="pre">_p_est</span></code>, <code class="docutils literal notranslate"><span class="pre">_p_est_prev</span></code> and formulate the stage cost (as a function of <code class="docutils literal notranslate"><span class="pre">_y_meas</span></code>, <code class="docutils literal notranslate"><span class="pre">_y_calc</span></code>) and the arrival cost (as a function of (<code class="docutils literal notranslate"><span class="pre">_x_prev</span></code>, <code class="docutils literal notranslate"><span class="pre">_x</span></code>, <code class="docutils literal notranslate"><span class="pre">_p_est</span></code>, <code class="docutils literal notranslate"><span class="pre">_p_est_prev</span></code>). Typically, we want to formulate the following objective:</p>
<div class="math notranslate nohighlight">
\[\begin{split}J=  &amp;\underbrace{(x_0 - \tilde{x}_0)^T P_x (x_0 - \tilde{x}_0)}_{\text{arrival cost states}} +
           \underbrace{(p_0 - \tilde{p}_0)^T P_p (p_0 - \tilde{p}_0)}_{\text{arrival cost params.}} \\
            &amp;+\sum_{k=0}^{n-1} \underbrace{(h(x_k, u_k, p_k) - y_k)^T P_{y,k} (h(x_k, u_k, p_k) - y_k)}_{\text{stage cost}}\end{split}\]</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">y_meas</span> <span class="o">=</span> <span class="n">mhe</span><span class="o">.</span><span class="n">_y_meas</span>
<span class="n">y_calc</span> <span class="o">=</span> <span class="n">mhe</span><span class="o">.</span><span class="n">_y_calc</span>

<span class="n">dy</span> <span class="o">=</span> <span class="n">y_meas</span><span class="o">.</span><span class="n">cat</span><span class="o">-</span><span class="n">y_calc</span><span class="o">.</span><span class="n">cat</span>
<span class="n">P_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">]))</span>

<span class="n">stage_cost</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">T</span><span class="nd">@P_y@dy</span>

<span class="n">x_0</span> <span class="o">=</span> <span class="n">mhe</span><span class="o">.</span><span class="n">_x</span>
<span class="n">x_prev</span> <span class="o">=</span> <span class="n">mhe</span><span class="o">.</span><span class="n">_x_prev</span>
<span class="n">p_0</span> <span class="o">=</span> <span class="n">mhe</span><span class="o">.</span><span class="n">_p_est</span>
<span class="n">p_prev</span> <span class="o">=</span> <span class="n">mhe</span><span class="o">.</span><span class="n">_p_est_prev</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">x_0</span><span class="o">.</span><span class="n">cat</span> <span class="o">-</span> <span class="n">x_prev</span><span class="o">.</span><span class="n">cat</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">p_0</span><span class="o">.</span><span class="n">cat</span> <span class="o">-</span> <span class="n">p_prev</span><span class="o">.</span><span class="n">cat</span>

<span class="n">P_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">P_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">arrival_cost</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="o">*</span><span class="n">dx</span><span class="o">.</span><span class="n">T</span><span class="nd">@P_x@dx</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="o">*</span><span class="n">dp</span><span class="o">.</span><span class="n">T</span><span class="nd">@P_p@dp</span>


<span class="n">mhe</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">stage_cost</span><span class="p">,</span> <span class="n">arrival_cost</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Fixed-parameters">
<h3>Fixed parameters<a class="headerlink" href="#Fixed-parameters" title="Permalink to this headline">¶</a></h3>
<p>If the model contains parameters and if we estimate only a subset of these parameters, it is required to pass a function that returns the value of the remaining parameters at each time step.</p>
<p>Furthermore, this function must return a specific structure, which is first obtained by calling:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">p_template_mhe</span> <span class="o">=</span> <span class="n">mhe</span><span class="o">.</span><span class="n">get_p_template</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Using this structure, we then formulate the following function for the remaining (not estimated) parameters:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">p_fun_mhe</span><span class="p">(</span><span class="n">t_now</span><span class="p">):</span>
    <span class="n">p_template_mhe</span><span class="p">[</span><span class="s1">&#39;Theta_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.25e-4</span>
    <span class="n">p_template_mhe</span><span class="p">[</span><span class="s1">&#39;Theta_3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.25e-4</span>
    <span class="k">return</span> <span class="n">p_template_mhe</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mhe</span><span class="o">.</span><span class="n">set_p_fun</span><span class="p">(</span><span class="n">p_fun_mhe</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Bounds">
<h3>Bounds<a class="headerlink" href="#Bounds" title="Permalink to this headline">¶</a></h3>
<p>The MHE implementation also supports bounds for states, inputs, parameters which can be set as shown below. For the given example, it is especially important to set realistic bounds on the estimated parameter. Otherwise the MHE solution is a poor fit.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mhe</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_m_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">mhe</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_m_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

<span class="n">mhe</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="s1">&#39;_p_est&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>
<span class="n">mhe</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span><span class="s1">&#39;_p_est&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Setup">
<h3>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h3>
<p>Similar to the controller, simulator and model, we finalize the MHE configuration by calling:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mhe</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Configuring-the-Simulator">
<h2>Configuring the Simulator<a class="headerlink" href="#Configuring-the-Simulator" title="Permalink to this headline">¶</a></h2>
<p>In many cases a developed control approach is first tested on a simulated system. <strong>do mpc</strong> responds to this need with the <code class="docutils literal notranslate"><span class="pre">do_mpc.simulator</span></code> class. The <code class="docutils literal notranslate"><span class="pre">simulator</span></code> uses state-of-the-art DAE solvers, e.g. Sundials <a class="reference external" href="https://computing.llnl.gov/projects/sundials/cvode">CVODE</a> to solve the DAE equations defined in the supplied <code class="docutils literal notranslate"><span class="pre">do_mpc.model</span></code>. This will often be the same model as defined for the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> but it is also possible to use a more complex model of the same system.</p>
<p>In this section we demonstrate how to setup the <code class="docutils literal notranslate"><span class="pre">simulator</span></code> class for the given example. We initilize the class with the previously defined <code class="docutils literal notranslate"><span class="pre">model</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Simulator-parameters">
<h3>Simulator parameters<a class="headerlink" href="#Simulator-parameters" title="Permalink to this headline">¶</a></h3>
<p>Next, we need to parametrize the <code class="docutils literal notranslate"><span class="pre">simulator</span></code>. Please see the API documentation for <code class="docutils literal notranslate"><span class="pre">simulator.set_param()</span></code> for a full description of available parameters and their meaning. Many parameters already have suggested default values. Most importantly, we need to set <code class="docutils literal notranslate"><span class="pre">t_step</span></code>. We choose the same value as for the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Instead of supplying a dict with the splat operator (**), as with the optimizer.set_param(),</span>
<span class="c1"># we can also use keywords (and call the method multiple times, if necessary):</span>
<span class="n">simulator</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">t_step</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Parameters">
<h3>Parameters<a class="headerlink" href="#Parameters" title="Permalink to this headline">¶</a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">model</span></code> we have defined the inertia of the masses as parameters. The <code class="docutils literal notranslate"><span class="pre">simulator</span></code> is now parametrized to simulate with the “true” values at each timestep. In the most general case, these values can change, which is why we need to supply a function that can be evaluted at each time to obtain the current values. <strong>do mpc</strong> requires this function to have a specific return structure which we obtain first by calling:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">p_template_sim</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">get_p_template</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>We need to now write a function which returns this structure with the desired numerial values. For our simple case:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">p_fun_sim</span><span class="p">(</span><span class="n">t_now</span><span class="p">):</span>
    <span class="n">p_template_sim</span><span class="p">[</span><span class="s1">&#39;Theta_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.25e-4</span>
    <span class="n">p_template_sim</span><span class="p">[</span><span class="s1">&#39;Theta_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.25e-4</span>
    <span class="n">p_template_sim</span><span class="p">[</span><span class="s1">&#39;Theta_3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.25e-4</span>
    <span class="k">return</span> <span class="n">p_template_sim</span>
</pre></div>
</div>
</div>
<p>This function is now supplied to the <code class="docutils literal notranslate"><span class="pre">simulator</span></code> in the following way:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span><span class="o">.</span><span class="n">set_p_fun</span><span class="p">(</span><span class="n">p_fun_sim</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Setup">
<h3>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h3>
<p>Finally, we call:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Creating-the-loop">
<h2>Creating the loop<a class="headerlink" href="#Creating-the-loop" title="Permalink to this headline">¶</a></h2>
<p>While the full loop should also include a controller, we are currently only interested in showcasing the estimator. We therefore estimate the states for an arbitrary initial condition and some random control inputs (shown below).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To make things more interesting we pass the estimator a perturbed initial state:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x0_mhe</span> <span class="o">=</span> <span class="n">x0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>and use the <code class="docutils literal notranslate"><span class="pre">.set_initial_state()</span></code> method to set the initial state:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span><span class="o">.</span><span class="n">set_initial_state</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">reset_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">mhe</span><span class="o">.</span><span class="n">set_initial_state</span><span class="p">(</span><span class="n">x0_mhe</span> <span class="p">,</span><span class="n">p_est0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e-4</span><span class="p">]),</span> <span class="n">reset_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Setting-up-the-Graphic">
<h3>Setting up the Graphic<a class="headerlink" href="#Setting-up-the-Graphic" title="Permalink to this headline">¶</a></h3>
<p>We are again using the <strong>do mpc</strong> <code class="docutils literal notranslate"><span class="pre">graphics</span></code> module. This versatile tool allows us to conveniently configure a user-defined plot based on Matplotlib and visualize the results stored in the <code class="docutils literal notranslate"><span class="pre">mhe.data</span></code>, <code class="docutils literal notranslate"><span class="pre">simulator.data</span></code> objects.</p>
<p>We start by importing matplotlib:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="c1"># Customizing Matplotlib:</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<p>And initializing the <code class="docutils literal notranslate"><span class="pre">graphics</span> <span class="pre">module</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graphics</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">Graphics</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Next, we create a <code class="docutils literal notranslate"><span class="pre">figure</span></code> and obtain its <code class="docutils literal notranslate"><span class="pre">axis</span></code> object. Matplotlib offers multiple alternative ways to obtain an <code class="docutils literal notranslate"><span class="pre">axis</span></code> object, e.g. <a class="reference external" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.subplots.html">subplots</a>, <a class="reference external" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.subplot2grid.html">subplot2grid</a>, or simply <a class="reference external" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.gca.html">gca</a>. We use <code class="docutils literal notranslate"><span class="pre">subplots</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%capture</span>
<span class="c1"># We just want to create the plot and not show it right now. This &quot;inline magic&quot; surpresses the output.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">align_ylabels</span><span class="p">()</span>

<span class="c1"># We create another figure to plot the parameters:</span>
<span class="n">fig_p</span><span class="p">,</span> <span class="n">ax_p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Most important API element for setting up the <code class="docutils literal notranslate"><span class="pre">graphics</span></code> module is <code class="docutils literal notranslate"><span class="pre">graphics.add_line</span></code>, which mimics the API of <code class="docutils literal notranslate"><span class="pre">model.add_variable</span></code>, except that we also need to pass an <code class="docutils literal notranslate"><span class="pre">axis</span></code>.</p>
<p>Note that we are only configuring the <code class="docutils literal notranslate"><span class="pre">graphics</span></code> module without showing anything just yet.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%capture</span>
<span class="c1"># Plot the angle positions (phi_1, phi_2, phi_2) on the first axis:</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;angle </span><span class="se">\n</span><span class="s1"> position [rad]&#39;</span><span class="p">)</span>

<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;dphi&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;angular </span><span class="se">\n</span><span class="s1"> velocity [rad/s]&#39;</span><span class="p">)</span>

<span class="c1"># Plot the set motor positions (phi_m_1_set, phi_m_2_set) on the second axis:</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_m_set&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;motor </span><span class="se">\n</span><span class="s1"> angle [rad]&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time [s]&#39;</span><span class="p">)</span>

<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_p&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Theta_1&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax_p</span><span class="p">)</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_p&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Theta_2&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax_p</span><span class="p">)</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_p&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Theta_3&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax_p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Running-the-loop">
<h3>Running the loop<a class="headerlink" href="#Running-the-loop" title="Permalink to this headline">¶</a></h3>
<p>We investigate the closed-loop MHE performance by alternating a simulation step (<code class="docutils literal notranslate"><span class="pre">y0=simulator.make_step(u0)</span></code>) and an estimation step (<code class="docutils literal notranslate"><span class="pre">x0=mhe.make_step(y0)</span></code>). Since we are lacking the controller which would close the loop (<code class="docutils literal notranslate"><span class="pre">u0=mpc.make_step(x0)</span></code>), we define a random control input function:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">random_u</span><span class="p">(</span><span class="n">u0</span><span class="p">):</span>
    <span class="n">u_next</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">switch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.8</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">switch</span><span class="p">)</span><span class="o">*</span><span class="n">u0</span> <span class="o">+</span> <span class="n">switch</span><span class="o">*</span><span class="n">u_next</span>
    <span class="k">return</span> <span class="n">u0</span>
</pre></div>
</div>
</div>
<p>The function holds a random value in the range of the allowed control inputs for a random time.</p>
<p>We can now run the loop, where we also add gaussian normal measurement noise:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%capture</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span> <span class="c1">#make it repeatable</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">random_u</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">n_y</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">mhe</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can visualize the resulting trajectory with the pre-defined graphic:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graphics</span><span class="o">.</span><span class="n">reset_axes</span><span class="p">()</span>
<span class="n">sim_lines</span> <span class="o">=</span> <span class="n">graphics</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">simulator</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">sim_lines</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;123&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Sim.&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">)</span>
<span class="n">mhe_lines</span> <span class="o">=</span> <span class="n">graphics</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">mhe</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">mhe_lines</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;123&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;MHE&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">)</span>
<span class="c1"># Mark the time after a full horizon is available to the MHE.</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Show the figure:</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/mhe_example_62_0.png" src="_images/mhe_example_62_0.png" />
</div>
</div>
<p>Parameter estimation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ax_p</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">4e-4</span><span class="p">)</span>
<span class="n">ax_p</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;mass inertia&#39;</span><span class="p">)</span>
<span class="n">ax_p</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time [s]&#39;</span><span class="p">)</span>
<span class="n">fig_p</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/mhe_example_64_0.png" src="_images/mhe_example_64_0.png" />
</div>
</div>
<p>Thank you, for following through this short example on how to use <strong>do mpc</strong>. We hope you find the tool and this documentation useful.</p>
<p>We also want to emphasize that we skipped over many details, further functions etc. in this introduction. Please have a look at our more complex examples to get a better impression of the possibilities with <strong>do mpc</strong>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="license.html" class="btn btn-neutral float-right" title="License" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Getting started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sergio Lucia

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>