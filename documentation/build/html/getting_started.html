

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Getting started &mdash; do-mpc 4.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"extensions": ["tex2jax.js"], "jax": ["input/TeX", "output/HTML-CSS"], "tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Getting started: Moving Horizon Estimation" href="mhe_example.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/dompc_var_02_white.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Example-system">Example system</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Creating-the-model">Creating the model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Model-variables">Model variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Model-parameters">Model parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Right-hand-side-equation">Right-hand-side equation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Configuring-the-MPC-controller">Configuring the MPC controller</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Optimizer-parameters">Optimizer parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Objective-function">Objective function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Constraints">Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Scaling">Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Uncertain-Parameters">Uncertain Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Setup">Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Configuring-the-Simulator">Configuring the Simulator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Simulator-parameters">Simulator parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Uncertain-parameters">Uncertain parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Setup">Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Creating-the-control-loop">Creating the control loop</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Setting-up-the-Graphic">Setting up the Graphic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Running-the-simulator">Running the simulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Running-the-optimizer">Running the optimizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Running-the-control-loop">Running the control loop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Data-processing">Data processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Saving-and-retrieving-results">Saving and retrieving results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Animating-results">Animating results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mhe_example.html">Getting started: Moving Horizon Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">do-mpc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Getting started</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/getting_started.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Getting-started">
<h1>Getting started<a class="headerlink" href="#Getting-started" title="Permalink to this headline">¶</a></h1>
<p>In this Jupyter Notebook we illustrate the core functionalities of <strong>do mpc</strong>.</p>
<p>We start by importing the required modules, most notably <code class="docutils literal notranslate"><span class="pre">do_mpc</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Add to path:</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">)</span>

<span class="c1"># Import do_mpc package:</span>
<span class="kn">import</span> <span class="nn">do_mpc</span>
</pre></div>
</div>
</div>
<p>One of the essential paradigms of <strong>do mpc</strong> is a modular architecture, where individual building bricks can be used independently our jointly, depending on the application.</p>
<p>This modular architecture is showcased in the flow chart below.</p>
<p><img alt="do_mpc_flow_sheet" src="_images/do_mpc_flow_sheet.png" /></p>
<p>In the following we will present the configuration, setup and connection between these blocks, starting with the <code class="docutils literal notranslate"><span class="pre">model</span></code>.</p>
<div class="section" id="Example-system">
<h2>Example system<a class="headerlink" href="#Example-system" title="Permalink to this headline">¶</a></h2>
<p>First, we introduce a simple system for which we setup <strong>do mpc</strong>. We want to control a triple mass spring system as depicted below: <img alt="triple_mass_schematic" src="_images/triple_mass_spring.png" /></p>
<p>Three rotating discs are connected via springs and we denote their angles as <span class="math notranslate nohighlight">\(\phi_1, \phi_2, \phi_3\)</span>. The two outermost discs are each connected to a stepper motor with additional springs. The stepper motor angles (<span class="math notranslate nohighlight">\(\phi_{m,1}\)</span> and <span class="math notranslate nohighlight">\(\phi_{m,2}\)</span> are used as inputs to the system. Relevant parameters of the system are the inertia <span class="math notranslate nohighlight">\(\Theta\)</span> of the three discs, the spring constants <span class="math notranslate nohighlight">\(c\)</span> as well as the damping factors <span class="math notranslate nohighlight">\(d\)</span>.</p>
<p>The second degree ODE of this system can be written as follows:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\Theta_1 \ddot{\phi}_1 = -c_1 \left(\phi_1 - \phi_{m,1} \right) -c_2 \left(\phi_1 - \phi_2 \right)- d_1 \dot{\phi}_1\\
\Theta_2 \ddot{\phi}_2 = -c_2 \left(\phi_2 - \phi_{1} \right) -c_3 \left(\phi_2 - \phi_3 \right)- d_2 \dot{\phi}_2\\
\Theta_3 \ddot{\phi}_3 = -c_3 \left(\phi_3 - \phi_2 \right) -c_4 \left(\phi_3 - \phi_{m,2} \right)- d_3 \dot{\phi}_3\end{split}\]</div>
<p>The uncontrolled system, starting from a non-zero initial state will osciallate for an extended period of time, as shown below:</p>
<p><img alt="SegmentLocal1" src="_images/anim_disc_3d_uncontrolled.gif" /></p>
<p>Later, we want to be able to use the motors efficiently to bring the oscillating masses to a rest. It will look something like this:</p>
<p><img alt="SegmentLocal2" src="_images/anim_disc_3d_ctrl_motor.gif" /></p>
</div>
<div class="section" id="Creating-the-model">
<h2>Creating the model<a class="headerlink" href="#Creating-the-model" title="Permalink to this headline">¶</a></h2>
<p>As indicated above, the <code class="docutils literal notranslate"><span class="pre">model</span></code> block is essential for the application of <strong>do mpc</strong>. In mathmatical terms the model is defined either as a continuous ordinary differential equation (ODE), a differential algebraic equation (DAE) or a discrete equation).</p>
<p>In the case of an DAE/ODE we write:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\frac{\partial x}{\partial t} = f(x,u,z,p)\\
0 = g(x,u,z,p)\\
y = h(x,u,z,p)\end{split}\]</div>
<p>We denote <span class="math notranslate nohighlight">\(x\in \mathbb{R}^{n_x}\)</span> as the states, <span class="math notranslate nohighlight">\(u \in \mathbb{R}^{n_u}\)</span> as the inputs, <span class="math notranslate nohighlight">\(z\in \mathbb{R}^{n_z}\)</span> the algebraic states and <span class="math notranslate nohighlight">\(p \in \mathbb{R}^{n_p}\)</span> as parameters.</p>
<p>We reformulate the second order ODEs above as the following first order ODEs, be introducing the following states:</p>
<div class="math notranslate nohighlight">
\[\begin{split}x_1 = \phi_1\\
x_2 = \phi_2\\
x_3 = \phi_3\\
x_4 = \dot{\phi}_1\\
x_5 = \dot{\phi}_2\\
x_6 = \dot{\phi}_3\\\end{split}\]</div>
<p>and derive the right-hand-side function <span class="math notranslate nohighlight">\(f(x,u,z,p)\)</span> as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\dot{x}_1 = x_4\\
\dot{x}_2 = x_5\\
\dot{x}_3 = x_6\\
\dot{x}_4 = -\frac{c_1}{\Theta_1} \left(x_1 - u_1 \right) -\frac{c_2}{\Theta_1} \left(x1 - x_2 \right)- \frac{d_1}{\Theta_1} x_4\\
\dot{x}_5 = -\frac{c_2}{\Theta_2} \left(x_2 - x_1 \right) -\frac{c_3}{\Theta_2} \left(x_2 - x_3 \right)- \frac{d_2}{\Theta_2} x_5\\
\dot{x}_6 = -\frac{c_3}{\Theta_3} \left(x_3 - x_2 \right) -\frac{c_4}{\Theta_3} \left(x_4 - u_2 \right)- \frac{d_3}{\Theta_3} x_6\\\end{split}\]</div>
<p>With this theoretical background we can start configuring the <strong>do mpc</strong> <code class="docutils literal notranslate"><span class="pre">model</span></code> object.</p>
<p>First, we need to decide on the model type. For the given example, we are working with a continuous model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;continuous&#39;</span> <span class="c1"># either &#39;discrete&#39; or &#39;continuous&#39;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Model-variables">
<h3>Model variables<a class="headerlink" href="#Model-variables" title="Permalink to this headline">¶</a></h3>
<p>The next step is to define the model variables. It is important to define the variable type, name and optionally shape (default is scalar variable). The following types are available:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 55%" />
<col style="width: 24%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Long name</p></th>
<th class="head"><p>short name</p></th>
<th class="head"><p>Remark</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">states</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">_x</span></code></p></td>
<td><p>Required</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">inputs</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">_u</span></code></p></td>
<td><p>Required</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">algebraic</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">_z</span></code></p></td>
<td><p>Optional</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">parameter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">_p</span></code></p></td>
<td><p>Optional</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">timevarying_parameter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">_tvp</span></code></p></td>
<td><p>Optional</p></td>
</tr>
</tbody>
</table>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">phi_1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_1&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">phi_2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_2&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">phi_3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_3&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># Variables can also be vectors:</span>
<span class="n">dphi</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;dphi&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># Two states for the desired (set) motor position:</span>
<span class="n">phi_m_1_set</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_m_1_set&#39;</span><span class="p">)</span>
<span class="n">phi_m_2_set</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_m_2_set&#39;</span><span class="p">)</span>
<span class="c1"># Two additional states for the true motor position:</span>
<span class="n">phi_1_m</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_1_m&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">phi_2_m</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_2_m&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">model.set_variable()</span></code> returns the symbolic variable:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi_1=</span><span class="si">{}</span><span class="s1">, with phi_1.shape=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phi_1</span><span class="p">,</span> <span class="n">phi_1</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dphi=</span><span class="si">{}</span><span class="s1">, with dphi.shape=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dphi</span><span class="p">,</span> <span class="n">dphi</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
phi_1=phi_1, with phi_1.shape=(1, 1)
dphi=[dphi_0, dphi_1, dphi_2], with dphi.shape=(3, 1)
</pre></div></div>
</div>
</div>
<div class="section" id="Model-parameters">
<h3>Model parameters<a class="headerlink" href="#Model-parameters" title="Permalink to this headline">¶</a></h3>
<p>Next we <strong>define parameters</strong>. Known values can and should be hardcoded but with robust MPC in mind, we define uncertain parameters explictly. We assume that the inertia is such an uncertain parameter and hardcode the spring constant and friction coefficient.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># As shown in the table above, we can use Long names or short names for the variable type.</span>
<span class="n">Theta_1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">)</span>
<span class="n">Theta_2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_2&#39;</span><span class="p">)</span>
<span class="n">Theta_3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_3&#39;</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.697</span><span class="p">,</span>  <span class="mf">2.66</span><span class="p">,</span>  <span class="mf">3.05</span><span class="p">,</span> <span class="mf">2.86</span><span class="p">])</span><span class="o">*</span><span class="mf">1e-3</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.78</span><span class="p">,</span>  <span class="mf">8.01</span><span class="p">,</span>  <span class="mf">8.82</span><span class="p">])</span><span class="o">*</span><span class="mf">1e-5</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Right-hand-side-equation">
<h3>Right-hand-side equation<a class="headerlink" href="#Right-hand-side-equation" title="Permalink to this headline">¶</a></h3>
<p>Finally, we set the right-hand-side of the model by calling <code class="docutils literal notranslate"><span class="pre">model.set_rhs(var_name,</span> <span class="pre">expr)</span></code> with the <code class="docutils literal notranslate"><span class="pre">var_name</span></code> from the state variables defined above and an expression in terms of <span class="math notranslate nohighlight">\(x, u, z, p\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;phi_1&#39;</span><span class="p">,</span> <span class="n">dphi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;phi_2&#39;</span><span class="p">,</span> <span class="n">dphi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;phi_3&#39;</span><span class="p">,</span> <span class="n">dphi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>For the vector valued state <code class="docutils literal notranslate"><span class="pre">dphi</span></code> we need to concatenate symbolic expressions. We import the symbolic library CasADi:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">casadi</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dphi_next</span> <span class="o">=</span> <span class="n">vertcat</span><span class="p">(</span>
    <span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_1</span><span class="o">*</span><span class="p">(</span><span class="n">phi_1</span><span class="o">-</span><span class="n">phi_1_m</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_1</span><span class="o">*</span><span class="p">(</span><span class="n">phi_1</span><span class="o">-</span><span class="n">phi_2</span><span class="p">)</span><span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_1</span><span class="o">*</span><span class="n">dphi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_2</span><span class="o">*</span><span class="p">(</span><span class="n">phi_2</span><span class="o">-</span><span class="n">phi_1</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_2</span><span class="o">*</span><span class="p">(</span><span class="n">phi_2</span><span class="o">-</span><span class="n">phi_3</span><span class="p">)</span><span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_2</span><span class="o">*</span><span class="n">dphi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_3</span><span class="o">*</span><span class="p">(</span><span class="n">phi_3</span><span class="o">-</span><span class="n">phi_2</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_3</span><span class="o">*</span><span class="p">(</span><span class="n">phi_3</span><span class="o">-</span><span class="n">phi_2_m</span><span class="p">)</span><span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Theta_3</span><span class="o">*</span><span class="n">dphi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;dphi&#39;</span><span class="p">,</span> <span class="n">dphi_next</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">tau</span> <span class="o">=</span> <span class="mf">1e-2</span>
<span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;phi_1_m&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">tau</span><span class="o">*</span><span class="p">(</span><span class="n">phi_m_1_set</span> <span class="o">-</span> <span class="n">phi_1_m</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s1">&#39;phi_2_m&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">tau</span><span class="o">*</span><span class="p">(</span><span class="n">phi_m_2_set</span> <span class="o">-</span> <span class="n">phi_2_m</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>The model setup is completed by calling <code class="docutils literal notranslate"><span class="pre">model.setup_model()</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model</span><span class="o">.</span><span class="n">setup_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>After calling <code class="docutils literal notranslate"><span class="pre">model.setup_model()</span></code> we cannot define further variables etc.</p>
</div>
</div>
<div class="section" id="Configuring-the-MPC-controller">
<h2>Configuring the MPC controller<a class="headerlink" href="#Configuring-the-MPC-controller" title="Permalink to this headline">¶</a></h2>
<p>With the configured and setup model we can now create the optimizer for Model Predictive Control (MPC). We start by creating the object (with the <code class="docutils literal notranslate"><span class="pre">model</span></code> as the only input)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mpc</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Optimizer-parameters">
<h3>Optimizer parameters<a class="headerlink" href="#Optimizer-parameters" title="Permalink to this headline">¶</a></h3>
<p>Next, we need to parametrize the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code>. Please see the API documentation for <code class="docutils literal notranslate"><span class="pre">optimizer.set_param()</span></code> for a full description of available parameters and their meaning. Many parameters already have suggested default values. Most importantly, we need to set <code class="docutils literal notranslate"><span class="pre">n_horizon</span></code> and <code class="docutils literal notranslate"><span class="pre">t_step</span></code>. We also choose <code class="docutils literal notranslate"><span class="pre">n_robust=1</span></code> for this example, which would default to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<p>Note that by default the continuous system is discretized with <code class="docutils literal notranslate"><span class="pre">collocation</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">setup_mpc</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;n_horizon&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s1">&#39;t_step&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;n_robust&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;store_full_solution&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">setup_mpc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Objective-function">
<h3>Objective function<a class="headerlink" href="#Objective-function" title="Permalink to this headline">¶</a></h3>
<p>The MPC formulation is at its core an optimization problem for which we need to define an objective function.</p>
<p>The full optimization problem is given below:</p>
<div class="math notranslate nohighlight">
\[\min_{x,u,z}\quad \sum_{k=0}^{n-1}\left( \underbrace{l(x_k,u_k,z_k,p)}_{\text{lagrange term}}
+ \underbrace{\Delta u_k^T R \Delta u_k}_{\text{r-term}}\right)
+ \underbrace{m(x_n)}_{\text{meyer term}}\]</div>
<p>We need to define the meyer term (<code class="docutils literal notranslate"><span class="pre">mterm</span></code>) and lagrange term (<code class="docutils literal notranslate"><span class="pre">lterm</span></code>). For the given example we set:</p>
<div class="math notranslate nohighlight">
\[\begin{split}l(x_k,u_k,z_k,p) = \phi_1^2+\phi_2^2+\phi_3^2\\
m(x_n) = \phi_1^2+\phi_2^2+\phi_3^2\end{split}\]</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mterm</span> <span class="o">=</span> <span class="n">phi_1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_3</span><span class="o">**</span><span class="mi">2</span>
<span class="n">lterm</span> <span class="o">=</span> <span class="n">phi_1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_3</span><span class="o">**</span><span class="mi">2</span>

<span class="n">mpc</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">mterm</span><span class="o">=</span><span class="n">mterm</span><span class="p">,</span> <span class="n">lterm</span><span class="o">=</span><span class="n">lterm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Part of the objective function is also the <strong>penality for the control inputs</strong>. This penalty can often be used to <em>smoothen</em> the obtained optimal solution and is an important tuning parameter. We add a quadratic penalty on changes:</p>
<div class="math notranslate nohighlight">
\[\Delta u_k = u_k - u_{k-1}\]</div>
<p>and automatically supply the solver with the previous solution of <span class="math notranslate nohighlight">\(u_{k-1}\)</span> for <span class="math notranslate nohighlight">\(\Delta u_0\)</span>.</p>
<p>The user can set the tuning factor for these quadratic terms like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mpc</span><span class="o">.</span><span class="n">set_rterm</span><span class="p">(</span>
    <span class="n">phi_m_1_set</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
    <span class="n">phi_m_2_set</span><span class="o">=</span><span class="mf">1e-2</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>where the keyword arguments refer to the previously defined input names. Note that in the notation above (<span class="math notranslate nohighlight">\(\Delta u_k^T R \Delta u_k\)</span>), this results in setting the diagonal elements of <span class="math notranslate nohighlight">\(R\)</span>.</p>
</div>
<div class="section" id="Constraints">
<h3>Constraints<a class="headerlink" href="#Constraints" title="Permalink to this headline">¶</a></h3>
<p>It is an important feature of MPC to be able to set constraints on inputs and states. In <strong>do mpc</strong> these constraints are set like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Lower bounds on states:</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="c1"># Upper bounds on states</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

<span class="c1"># Lower bounds on inputs:</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_m_1_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_m_2_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="c1"># Lower bounds on inputs:</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_m_1_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_m_2_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Scaling">
<h3>Scaling<a class="headerlink" href="#Scaling" title="Permalink to this headline">¶</a></h3>
<p>Scaling is an important feature if the OCP is poorly conditioned, e.g. different states have significantly different magnitudes. In that case the unscaled problem might not lead to a (desired) solution. Scaling factors can be introduced for all states, inputs and algebraic variables and the objective is to scale them to roughly the same order of magnitude. For the given problem, this is not necessary but we briefly show the syntax (note that this step can also be skipped).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mpc</span><span class="o">.</span><span class="n">scaling</span><span class="p">[</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">scaling</span><span class="p">[</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">scaling</span><span class="p">[</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Uncertain-Parameters">
<h3>Uncertain Parameters<a class="headerlink" href="#Uncertain-Parameters" title="Permalink to this headline">¶</a></h3>
<p>An important feature of <strong>do mpc</strong> is scenario based robust MPC. Instead of predicting and controlling a single future trajectory, we investigate multiple possible trajectories depending on different uncertain parameters. These parameters were previously defined in the model (the mass inertia). Now we must provide the optimizer with different possible scenarios.</p>
<p>This can be done in the following way:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">inertia_mass_1</span> <span class="o">=</span> <span class="mf">2.25</span><span class="o">*</span><span class="mf">1e-4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">inertia_mass_2</span> <span class="o">=</span> <span class="mf">2.25</span><span class="o">*</span><span class="mf">1e-4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">inertia_mass_3</span> <span class="o">=</span> <span class="mf">2.25</span><span class="o">*</span><span class="mf">1e-4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span>

<span class="n">mpc</span><span class="o">.</span><span class="n">set_uncertainty_values</span><span class="p">([</span><span class="n">inertia_mass_1</span><span class="p">,</span> <span class="n">inertia_mass_2</span><span class="p">,</span> <span class="n">inertia_mass_3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>We provide a list to the method <code class="docutils literal notranslate"><span class="pre">optimizer.set_uncertain_parameter()</span></code>, where each entry is a <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> with the possible values. The first value is the nominal case, where further values will lead to an increasing number of scenarios. Since we investigate each combination of possible parameters, the number of scenarios is growing rapidly. For our example, we are therefore only treating the inertia of mass 1 and 2 as uncertain and supply only one possible value for the mass of inertia
3.</p>
</div>
<div class="section" id="Setup">
<h3>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h3>
<p>The last step of configuring the optimizer is to call <code class="docutils literal notranslate"><span class="pre">optimizer.setup</span></code>, which finalizes the setup and creates the optimization problem. Only now can we use the optimizer to obtain the control input.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mpc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Configuring-the-Simulator">
<h2>Configuring the Simulator<a class="headerlink" href="#Configuring-the-Simulator" title="Permalink to this headline">¶</a></h2>
<p>In many cases a developed control approach is first tested on a simulated system. <strong>do mpc</strong> responds to this need with the <code class="docutils literal notranslate"><span class="pre">do_mpc.simulator</span></code> class. The <code class="docutils literal notranslate"><span class="pre">simulator</span></code> uses state-of-the-art DAE solvers, e.g. Sundials <a class="reference external" href="https://computing.llnl.gov/projects/sundials/cvode">CVODE</a> to solve the DAE equations defined in the supplied <code class="docutils literal notranslate"><span class="pre">do_mpc.model</span></code>. This will often be the same model as defined for the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> but it is also possible to use a more complex model of the same system.</p>
<p>In this section we demonstrate how to setup the <code class="docutils literal notranslate"><span class="pre">simulator</span></code> class for the given example. We initilize the class with the previously defined <code class="docutils literal notranslate"><span class="pre">model</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Simulator-parameters">
<h3>Simulator parameters<a class="headerlink" href="#Simulator-parameters" title="Permalink to this headline">¶</a></h3>
<p>Next, we need to parametrize the <code class="docutils literal notranslate"><span class="pre">simulator</span></code>. Please see the API documentation for <code class="docutils literal notranslate"><span class="pre">simulator.set_param()</span></code> for a full description of available parameters and their meaning. Many parameters already have suggested default values. Most importantly, we need to set <code class="docutils literal notranslate"><span class="pre">t_step</span></code>. We choose the same value as for the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Instead of supplying a dict with the splat operator (**), as with the optimizer.set_param(),</span>
<span class="c1"># we can also use keywords (and call the method multiple times, if necessary):</span>
<span class="n">simulator</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">t_step</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Uncertain-parameters">
<h3>Uncertain parameters<a class="headerlink" href="#Uncertain-parameters" title="Permalink to this headline">¶</a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">model</span></code> we have defined the inertia of the masses as parameters, for which we have choosen multiple scenarios in the <code class="docutils literal notranslate"><span class="pre">optmizer</span></code>. The <code class="docutils literal notranslate"><span class="pre">simulator</span></code> is now parametrized to simulate with the “true” values at each timestep. In the most general case, these values can change, which is why we need to supply a function that can be evaluted at each time to obtain the current values. <strong>do mpc</strong> requires this function to have a specific return structure which we obtain first by calling:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">p_template</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">get_p_template</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>This object is a CasADi structure:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">type</span><span class="p">(</span><span class="n">p_template</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
casadi.tools.structure3.DMStruct
</pre></div></div>
</div>
<p>which can be indexed with the following keys:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">p_template</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;default&#39;, &#39;Theta_1&#39;, &#39;Theta_2&#39;, &#39;Theta_3&#39;]
</pre></div></div>
</div>
<p>We need to now write a function which returns this structure with the desired numerial values. For our simple case:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">p_fun</span><span class="p">(</span><span class="n">t_now</span><span class="p">):</span>
    <span class="n">p_template</span><span class="p">[</span><span class="s1">&#39;Theta_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.25e-4</span>
    <span class="n">p_template</span><span class="p">[</span><span class="s1">&#39;Theta_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.25e-4</span>
    <span class="n">p_template</span><span class="p">[</span><span class="s1">&#39;Theta_3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.25e-4</span>
    <span class="k">return</span> <span class="n">p_template</span>
</pre></div>
</div>
</div>
<p>This function is now supplied to the <code class="docutils literal notranslate"><span class="pre">simulator</span></code> in the following way:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span><span class="o">.</span><span class="n">set_p_fun</span><span class="p">(</span><span class="n">p_fun</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Setup">
<h3>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h3>
<p>Similarly to the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> we need to call <code class="docutils literal notranslate"><span class="pre">simulator.setup()</span></code> to finalize the setup of the simulator.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Creating-the-control-loop">
<h2>Creating the control loop<a class="headerlink" href="#Creating-the-control-loop" title="Permalink to this headline">¶</a></h2>
<p>In theory, we could now also create an estimator but for this concise example we just assume direct state-feedback. This means we are now ready to setup and run the control loop. The control loop consists of running the optimizer with the current state (<span class="math notranslate nohighlight">\(x_0\)</span>) to obtain the current control input (<span class="math notranslate nohighlight">\(u_0\)</span>) and then running the simulator with the current control input (<span class="math notranslate nohighlight">\(u_0\)</span>) to obtain the next state.</p>
<p>As discussed before, we setup a controller for regulating a triple-mass-spring system. To show some interesting control action we choose an arbitrary initial state <span class="math notranslate nohighlight">\(x_0\neq 0\)</span>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>and use the <code class="docutils literal notranslate"><span class="pre">.set_initial_state()</span></code> method to set the initial state (which also calls <code class="docutils literal notranslate"><span class="pre">optimizer.set_initial_guess()</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span><span class="o">.</span><span class="n">set_initial_state</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">reset_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_initial_state</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">reset_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Setting-up-the-Graphic">
<h3>Setting up the Graphic<a class="headerlink" href="#Setting-up-the-Graphic" title="Permalink to this headline">¶</a></h3>
<p>To investigate the controller performance <strong>AND</strong> the MPC predictions, we are using the <strong>do mpc</strong> <code class="docutils literal notranslate"><span class="pre">graphics</span></code> module. This versatile tool allows us to conveniently configure a user-defined plot based on Matplotlib and visualize the results stored in the <code class="docutils literal notranslate"><span class="pre">optimizer.data</span></code>, <code class="docutils literal notranslate"><span class="pre">simulator.data</span></code> (and if applicable <code class="docutils literal notranslate"><span class="pre">estimator.data</span></code>) objects.</p>
<p>We start by importing matplotlib:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="c1"># Customizing Matplotlib:</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<p>And initializing the <code class="docutils literal notranslate"><span class="pre">graphics</span> <span class="pre">module</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graphics</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">Graphics</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Next, we create a <code class="docutils literal notranslate"><span class="pre">figure</span></code> and obtain its <code class="docutils literal notranslate"><span class="pre">axis</span></code> object. Matplotlib offers multiple alternative ways to obtain an <code class="docutils literal notranslate"><span class="pre">axis</span></code> object, e.g. <a class="reference external" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.subplots.html">subplots</a>, <a class="reference external" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.subplot2grid.html">subplot2grid</a>, or simply <a class="reference external" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.gca.html">gca</a>. We use <code class="docutils literal notranslate"><span class="pre">subplots</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%capture</span>
<span class="c1"># We just want to create the plot and not show it right now. This &quot;inline magic&quot; surpresses the output.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">align_ylabels</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Most important API element for setting up the <code class="docutils literal notranslate"><span class="pre">graphics</span></code> module is <code class="docutils literal notranslate"><span class="pre">graphics.add_line</span></code>, which mimics the API of <code class="docutils literal notranslate"><span class="pre">model.add_variable</span></code>, except that we also need to pass an <code class="docutils literal notranslate"><span class="pre">axis</span></code>.</p>
<p>Note that we are only configuring the <code class="docutils literal notranslate"><span class="pre">graphics</span></code> module without showing anything just yet.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%capture</span>
<span class="c1"># Plot the angle positions (phi_1, phi_2, phi_2) on the first axis:</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_1&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_2&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_3&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;angle position [rad]&#39;</span><span class="p">)</span>

<span class="c1"># Plot the set motor positions (phi_m_1_set, phi_m_2_set) on the second axis:</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_m_1_set&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;phi_m_2_set&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;motor angle [rad]&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time [s]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Running-the-simulator">
<h3>Running the simulator<a class="headerlink" href="#Running-the-simulator" title="Permalink to this headline">¶</a></h3>
<p>We start investigating the <strong>do mpc</strong> simulator and the <code class="docutils literal notranslate"><span class="pre">graphics</span></code> package by simulating the autonomous system without control inputs (<span class="math notranslate nohighlight">\(u = 0\)</span>). This can be done as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">simulator</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can visualize the resulting trajectory with the pre-defined graphic:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graphics</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">simulator</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># Show the figure:</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/getting_started_80_0.png" src="_images/getting_started_80_0.png" />
</div>
</div>
<p>As desired, the motor angle (input) is constant at zero and the oscillating masses slowly come to a rest. Our control goal is to significantly shorten the time until the discs are stationary.</p>
<p>Remember the animation you saw above, of the uncontrolled system? This is where the data came from.</p>
</div>
<div class="section" id="Running-the-optimizer">
<h3>Running the optimizer<a class="headerlink" href="#Running-the-optimizer" title="Permalink to this headline">¶</a></h3>
<p>To obtain the current control input we call <code class="docutils literal notranslate"><span class="pre">optimizer.make_step(x0)</span></code> with the current state (<span class="math notranslate nohighlight">\(x_0\)</span>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">u0</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt
******************************************************************************

This is Ipopt version 3.12.12, running with linear solver mumps.
NOTE: Other linear solvers might be more efficient (see Ipopt documentation).

Number of nonzeros in equality constraint Jacobian...:    19448
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:     1229

Total number of variables............................:     6408
                     variables with only lower bounds:        0
                variables with lower and upper bounds:     2435
                     variables with only upper bounds:        0
Total number of equality constraints.................:     5768
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  8.8086219e+02 1.65e+01 1.07e-01  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  2.8794996e+02 2.32e+00 1.68e+00  -1.0 1.38e+01  -4.0 2.82e-01 8.60e-01f  1
   2  2.0017562e+02 1.73e-14 3.95e+00  -1.0 3.56e+00  -4.5 1.96e-01 1.00e+00f  1
   3  1.6039802e+02 1.87e-14 3.82e-01  -1.0 3.43e+00  -5.0 5.14e-01 1.00e+00f  1
   4  1.3046012e+02 1.55e-14 7.36e-02  -1.0 2.94e+00  -5.4 7.75e-01 1.00e+00f  1
   5  1.1452477e+02 2.58e-14 1.94e-02  -1.7 2.62e+00  -5.9 8.44e-01 1.00e+00f  1
   6  1.1247422e+02 2.33e-14 7.23e-03  -2.5 9.17e-01  -6.4 8.27e-01 1.00e+00f  1
   7  1.1235000e+02 1.42e-14 4.88e-08  -2.5 3.56e-01  -6.9 1.00e+00 1.00e+00f  1
   8  1.1230585e+02 1.42e-14 8.91e-09  -3.8 1.95e-01  -7.3 1.00e+00 1.00e+00f  1
   9  1.1229857e+02 1.95e-14 8.02e-10  -5.7 5.26e-02  -7.8 1.00e+00 1.00e+00f  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  10  1.1229833e+02 1.60e-14 6.08e-09  -5.7 1.20e+00  -8.3 1.00e+00 1.00e+00f  1
  11  1.1229831e+02 1.75e-14 3.25e-13  -8.6 1.92e-04  -8.8 1.00e+00 1.00e+00f  1

Number of Iterations....: 11

                                   (scaled)                 (unscaled)
Objective...............:   1.1229831239969913e+02    1.1229831239969913e+02
Dual infeasibility......:   3.2478880696018564e-13    3.2478880696018564e-13
Constraint violation....:   1.7541523789077473e-14    1.7541523789077473e-14
Complementarity.........:   4.2481089750730680e-09    4.2481089750730680e-09
Overall NLP error.......:   4.2481089750730680e-09    4.2481089750730680e-09


Number of objective function evaluations             = 12
Number of objective gradient evaluations             = 12
Number of equality constraint evaluations            = 12
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 12
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 11
Total CPU secs in IPOPT (w/o function evaluations)   =      2.790
Total CPU secs in NLP function evaluations           =      0.017

EXIT: Optimal Solution Found.
               t_proc [s]   t_wall [s]    n_eval
           S         3.25         1.63         1
       nlp_f     0.000461     0.000235        12
       nlp_g      0.00565      0.00275        12
    nlp_grad     0.000843      0.00042         1
  nlp_grad_f      0.00142      0.00073        13
  nlp_hess_l     0.000392     0.000186        11
   nlp_jac_g      0.00948      0.00465        13
</pre></div></div>
</div>
<p>Note that we obtained the output from IPOPT regarding the given optimal control problem (OCP). Most importantly we obtained <code class="docutils literal notranslate"><span class="pre">Optimal</span> <span class="pre">Solution</span> <span class="pre">Found</span></code>.</p>
<p>The configured <code class="docutils literal notranslate"><span class="pre">graphics</span></code> module is very useful to investigate the obtained solution by plotting the predicted system behavior. We simply need to call:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graphics</span><span class="o">.</span><span class="n">reset_axes</span><span class="p">()</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">graphics</span><span class="o">.</span><span class="n">plot_predictions</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1"># Autoscale the axis:</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">autoscale</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">autoscale</span><span class="p">()</span>
<span class="c1"># Show the figure:</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/getting_started_85_0.png" src="_images/getting_started_85_0.png" />
</div>
</div>
<p>We are seeing the predicted trajectories for the states and the optimal control inputs. Note that we are seeing different scenarios for the configured uncertain inertia of the three masses.</p>
<p>We can also see that the solution is considering the defined upper and lower bounds. This is especially true for the inputs.</p>
<p>As a conclusion, the results look as expected and can be assessed in the closed-loop application.</p>
</div>
<div class="section" id="Running-the-control-loop">
<h3>Running the control loop<a class="headerlink" href="#Running-the-control-loop" title="Permalink to this headline">¶</a></h3>
<p>Finally, we are now able to run the control loop as discussed above. We obtain the input from the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> and then run the <code class="docutils literal notranslate"><span class="pre">simulator</span></code>.</p>
<p>To make sure we start fresh, we reset the initial state and erase the history:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simulator</span><span class="o">.</span><span class="n">set_initial_state</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">reset_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_initial_state</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">reset_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This is the main-loop. We run 20 steps, whic is identical to the prediction horizon. Note that we use “capture” again, to surpress the output from IPOPT.</p>
<p>It is usually suggested to display the output as it contains important information about the state of the solver.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%capture</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now plot the previously shown prediction from time <span class="math notranslate nohighlight">\(t=0\)</span>, as well as the closed-loop trajectory from the simulator:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Clear previous lines</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">reset_axes</span><span class="p">()</span>
<span class="c1"># Plot predictions from t=0</span>
<span class="n">pred_lines</span> <span class="o">=</span> <span class="n">graphics</span><span class="o">.</span><span class="n">plot_predictions</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">t_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># Plot results until current time</span>
<span class="n">res_lines</span> <span class="o">=</span> <span class="n">graphics</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">simulator</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/getting_started_92_0.png" src="_images/getting_started_92_0.png" />
</div>
</div>
<p>The simulated trajectory with the nominal value of the parameters follows almost exactly the nominal open-loop predictions. The simulted trajectory is bounded from above and below by further uncertain scenarios.</p>
</div>
</div>
<div class="section" id="Data-processing">
<h2>Data processing<a class="headerlink" href="#Data-processing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Saving-and-retrieving-results">
<h3>Saving and retrieving results<a class="headerlink" href="#Saving-and-retrieving-results" title="Permalink to this headline">¶</a></h3>
<p><strong>do mpc</strong> results can be stored and retrieved with the methods <code class="docutils literal notranslate"><span class="pre">save_results</span></code> and <code class="docutils literal notranslate"><span class="pre">load_results</span></code> from the <code class="docutils literal notranslate"><span class="pre">do_mpc.data</span></code> module. We start by importing these methods:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">do_mpc.data</span> <span class="k">import</span> <span class="n">save_results</span><span class="p">,</span> <span class="n">load_results</span>
</pre></div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">save_results</span></code> is passed a list of the <strong>do mpc</strong> objects that we want to store. In our case, the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> and <code class="docutils literal notranslate"><span class="pre">simulator</span></code> are available and configured.</p>
<p>Note that by default results are stored in the subfolder <code class="docutils literal notranslate"><span class="pre">results</span></code> under the name <code class="docutils literal notranslate"><span class="pre">results.pkl</span></code>. Both can be changed and the folder is created if it doesn’t exist already.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">save_results</span><span class="p">([</span><span class="n">mpc</span><span class="p">,</span> <span class="n">simulator</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>We investigate the content of the newly created folder:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;./results/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;results.pkl&#39;]
</pre></div></div>
</div>
<p>Automatically, the <code class="docutils literal notranslate"><span class="pre">save_results</span></code> call will check if a file with the given name already exists. To avoid overwriting, the method prepends an index. If we save again, the folder contains:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">save_results</span><span class="p">([</span><span class="n">mpc</span><span class="p">,</span> <span class="n">simulator</span><span class="p">])</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;./results/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;001_results.pkl&#39;, &#39;results.pkl&#39;]
</pre></div></div>
</div>
<p>The pickled results can be loaded manually by writing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>or by calling <code class="docutils literal notranslate"><span class="pre">load_results</span></code> with the appropriate <code class="docutils literal notranslate"><span class="pre">file_name</span></code> (and path). <code class="docutils literal notranslate"><span class="pre">load_results</span></code> contains simply the code above for more convenience.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">results</span> <span class="o">=</span> <span class="n">load_results</span><span class="p">(</span><span class="s1">&#39;./results/results.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The obtained <code class="docutils literal notranslate"><span class="pre">results</span></code> is a dictionary with the <code class="docutils literal notranslate"><span class="pre">data</span></code> objects from the passed <strong>do mpc</strong> modules. Such that: <code class="docutils literal notranslate"><span class="pre">results['optimizer']</span></code> and <code class="docutils literal notranslate"><span class="pre">optimizer.data</span></code> contain the same information (similarly for <code class="docutils literal notranslate"><span class="pre">simulator</span></code> and, if applicable, <code class="docutils literal notranslate"><span class="pre">estimator</span></code>).</p>
</div>
<div class="section" id="Animating-results">
<h3>Animating results<a class="headerlink" href="#Animating-results" title="Permalink to this headline">¶</a></h3>
<p>Animating MPC results, to compare prediction and closed-loop trajectories, allows for a very meaningful investigation of the obtained results.</p>
<p><strong>do mpc</strong> significantly facilitates this process while working hand in hand with Matplotlib for full customizability. Obtaining publication ready animations is as easy as writing the following short blocks of code:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="k">import</span> <span class="n">FuncAnimation</span><span class="p">,</span> <span class="n">FFMpegWriter</span><span class="p">,</span> <span class="n">ImageMagickWriter</span>

<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">t_ind</span><span class="p">):</span>
    <span class="n">graphics</span><span class="o">.</span><span class="n">reset_axes</span><span class="p">()</span>
    <span class="n">graphics</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">simulator</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">t_ind</span><span class="o">=</span><span class="n">t_ind</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">graphics</span><span class="o">.</span><span class="n">plot_predictions</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">t_ind</span><span class="o">=</span><span class="n">t_ind</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">graphics</span></code> module can also be used without restrictions with loaded <strong>do mpc</strong> data. This allows for convenient data post-processing, e.g. in a Jupyter Notebook. With the <code class="docutils literal notranslate"><span class="pre">results</span></code> dict from above we have to write:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">t_ind</span><span class="p">):</span>
    <span class="n">graphics</span><span class="o">.</span><span class="n">reset_axes</span><span class="p">()</span>
    <span class="n">graphics</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;simulator&#39;</span><span class="p">],</span> <span class="n">t_ind</span><span class="o">=</span><span class="n">t_ind</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">graphics</span><span class="o">.</span><span class="n">plot_predictions</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;mpc&#39;</span><span class="p">],</span> <span class="n">t_ind</span><span class="o">=</span><span class="n">t_ind</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">gif_writer</span> <span class="o">=</span> <span class="n">ImageMagickWriter</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;anim.gif&#39;</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">gif_writer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Below we showcase the resulting gif file (not in real-time): <img alt="SegmentLocal" src="_images/anim.gif" /></p>
<p>Thank you, for following through this short example on how to use <strong>do mpc</strong>. We hope you find the tool and this documentation useful.</p>
<p>We suggest that you have a look at the API documentation for further details on the presented modules, methods and functions.</p>
<p>We also want to emphasize that we skipped over many details, further functions etc. in this introduction. Please have a look at our more complex examples to get a better impression of the possibilities with <strong>do mpc</strong>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="mhe_example.html" class="btn btn-neutral float-right" title="Getting started: Moving Horizon Estimation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="overview.html" class="btn btn-neutral float-left" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sergio Lucia

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>